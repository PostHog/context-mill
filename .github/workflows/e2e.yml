name: PostHog Examples - E2E tests
permissions:
  contents: read

# Temporarily disabled - uncomment triggers to re-enable
# on:
#   schedule:
#     # Runs nightly at 12am PST (which is 8am UTC)
#     - cron: '0 8 * * *'
#   workflow_dispatch:

on:
  workflow_dispatch:
    inputs:
      placeholder:
        description: 'Workflow is disabled. This input is a placeholder.'
        required: false

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      examples: ${{ steps.set-examples.outputs.examples }}
    steps:
    - uses: actions/checkout@v4

    - name: Discover examples with Playwright configs
      id: set-examples
      run: |
        examples=$(find basics -maxdepth 2 -name "playwright.config.ts" -exec dirname {} \; | sed 's|^basics/||' | jq -R -s -c 'split("\n")[:-1]')
        echo "examples=$examples" >> $GITHUB_OUTPUT
        echo "Found examples: $examples"

  test:
    needs: discover
    if: needs.discover.outputs.examples != '[]'
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example: ${{ fromJson(needs.discover.outputs.examples) }}
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Install dependencies
      run: |
        cd basics/${{ matrix.example }}
        pnpm install

    - name: Install Playwright Browsers
      run: |
        cd basics/${{ matrix.example }}
        pnpm exec playwright install chromium --with-deps

    - name: Run E2E Playwright tests
      run: |
        cd basics/${{ matrix.example }}
        pnpm run test:e2e
      env:
        NEXT_PUBLIC_POSTHOG_KEY: ${{ vars.NEXT_PUBLIC_POSTHOG_KEY }}
        NEXT_PUBLIC_POSTHOG_HOST: ${{ vars.NEXT_PUBLIC_POSTHOG_HOST }}
        PERSONAL_ACCESS_KEY: ${{ secrets.PERSONAL_ACCESS_KEY }}
        PROJECT_ID: ${{ vars.PROJECT_ID }}

    - name: Send failure event to PostHog
      if: failure()
      env:
        COMMIT_SHA: ${{ github.sha }}
        JOB_STATUS: ${{ job.status }}
        COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
        GH_REF: ${{ github.ref }}
        GH_WORKFLOW: ${{ github.workflow }}
        RUN_ID: ${{ github.run_id }}
        RUN_NUMBER: ${{ github.run_number }}
        JOB_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        MATRIX_EXAMPLE: ${{ matrix.example }}
      run: |
        curl -X POST https://webhooks.us.posthog.com/public/webhooks/019a7a81-7961-0000-d3e3-b5f34cc2a32b \
          -H "Content-Type: application/json" \
          -d "$(jq -n \
            --arg event "posthog-examples-repo-test-failure" \
            --arg commitSha "$COMMIT_SHA" \
            --arg jobStatus "$JOB_STATUS" \
            --arg commitMessage "$COMMIT_MESSAGE" \
            --arg commitAuthor "$COMMIT_AUTHOR" \
            --arg ref "$GH_REF" \
            --arg workflow "$GH_WORKFLOW" \
            --arg runId "$RUN_ID" \
            --arg runNumber "$RUN_NUMBER" \
            --arg jobUrl "$JOB_URL" \
            --arg matrixExample "$MATRIX_EXAMPLE" \
            '{event: $event, commitSha: $commitSha, jobStatus: $jobStatus, commitMessage: $commitMessage, commitAuthor: $commitAuthor, ref: $ref, workflow: $workflow, runId: $runId, runNumber: $runNumber, jobUrl: $jobUrl, matrixExample: $matrixExample}')"

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.example }}
        path: basics/${{ matrix.example }}/playwright-report/
        retention-days: 30

